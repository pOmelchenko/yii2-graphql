image: alpine:3.19

variables:
  GIT_STRATEGY: clone

stages:
  - sync
  - release

sync_upstream:
  stage: sync
  before_script:
    - apk add --no-cache git openssh-client
    - git config user.name "gitlab-ci"
    - git config user.email "ci@example.com"
  script:
    - git remote add upstream "$UPSTREAM_URL"
    - git fetch upstream "$UPSTREAM_BRANCH" --tags
    - git checkout "$CI_COMMIT_BRANCH"
    - git merge --ff-only "upstream/$UPSTREAM_BRANCH"
    - >
      git push
      "https://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
      HEAD:"$CI_COMMIT_BRANCH"
      --follow-tags
  rules:
    - if: '$CI_COMMIT_BRANCH == $UPSTREAM_BRANCH'
    - when: never
  allow_failure: false

publish_package:
  stage: release
  needs:
    - job: sync_upstream
      optional: true
  rules:
    - if: '$CI_COMMIT_TAG'
      when: manual
  before_script:
    - apk add --no-cache curl
  script:
    - >
      curl --fail-with-body
      --header "Job-Token: $CI_JOB_TOKEN"
      --data tag="${CI_COMMIT_TAG}"
      "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/composer"
  environment: production
